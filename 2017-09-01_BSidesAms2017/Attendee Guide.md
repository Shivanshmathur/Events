# Automating security with PowerShell

## Session description
There is no doubt that security has been in the spotlight over the last few years, recent events have been responsible for the increased demand for better and more secure systems. Security was often treated as an afterthought or something that could be implemented ‘later’. In this session, we will go over some best practices, using existing tools and frameworks to help you set up a more secure environment and to get a grasp of what is happening in your environment. We will leverage your existing automation skills to secure and automate these workflows. Expect a session with a lot of demos and resources that can directly be implemented.

## PowerSploit
> PowerSploit is a collection of Microsoft PowerShell modules that can be used to aid penetration testers during all phases of an assessment.

https://github.com/PowerShellMafia/PowerSploit

## PowerSploit blogging series on PowerShell Magazine
> PowerSploit is an offensive security framework for penetration testers and reverse engineers. It was born out of the realization that PowerShell was the ideal post-exploitation utility in Windows due to its ability to perform a wide range of administrative and low-level tasks all without the need to drop malicious executables to disk, thus, evading antivirus products with ease.

http://www.powershellmagazine.com/2014/07/08/powersploit/

## Not PowerShell
> The repository for Not PowerShell

https://github.com/Ben0xA/nps

## Detecting and Preventing PowerShell Downgrade Attacks
> ### PowerShell Downgrade Attacks
> There are two ways to do this:
> Command Line Version Parameter
> The simplest technique is: “PowerShell –Version 2 –Command <…>” (or of course any of the –Version abbreviations).
> PowerShell.exe itself is just a simple native application that hosts the CLR, and the –Version switch tells PowerShell which version of the PowerShell assemblies to load.
> Unfortunately, the PowerShell v5 enhancements did NOT include time travel, so the v2 binaries that were shipped in 2008 did NOT include the code we wrote in 2014.  The 2.0 .NET Framework (which is required for PowerShell’s V2 engine) is not included by default in Win10+, but an attacker or Red Teamer could enable it or install it. Prior to Windows 10, where it is available by default, they could just use it.
>  
> ### Hosting Applications Compiled using V2 Reference Assemblies
> When somebody compiles a C# application to leverage the PowerShell engine, they link against reference assemblies when they do that. If they link against the PowerShell v2 reference assemblies during development, Windows will use the PowerShell v2 engine (if available) when the application runs. Otherwise, PowerShell's type forwarding will run the application using the currently installed PowerShell engine.
> This is what happens when PowerShell Empire's "psinject" module attempts to load PowerShell into another process (such as notepad).

http://www.leeholmes.com/blog/2017/03/17/detecting-and-preventing-powershell-downgrade-attacks/

## Detecting Obfuscation
> In a recent post, we talked a little bit about detecting obfuscated PowerShell through the use of PowerShell's tokenizer - tackling, as an example, the highly irregular variable names generated by MetaSploit's PowerShell encoder.
> Obfuscation has been around as long as computer programs have, so the rise of obfuscated PowerShell scripts shouldn't be much of a surprise. Obfuscated VBScript, Perl, Ruby, Python, and of course assembly language are very common.
> A great example comes from this blog: http://perl-users.jp/articles/advent-calendar/2010/sym/11, which relies heavily on dynamic evaluation through Invoke-Expression.

http://www.leeholmes.com/blog/2016/10/22/more-detecting-obfuscated-powershell/

## Microsoft 'WannaCry' MS17-010 Security Bulletin
> This security update resolves vulnerabilities in Microsoft Windows. The most severe of the vulnerabilities could allow remote code execution if an attacker sends specially crafted messages to a Microsoft Server Message Block 1.0 (SMBv1) server.
> This security update is rated Critical for all supported releases of Microsoft Windows. For more information, see the Affected Software and Vulnerability Severity Ratings section.
> The security update addresses the vulnerabilities by correcting how SMBv1 handles specially crafted requests.

https://technet.microsoft.com/en-us/library/security/ms17-010.aspx